{% extends "base.html" %}
{% block content %}
<section class="grid">
  <div class="col chat-col card">
    <div id="messages" class="messages">
      <div class="bubble bot">×©×œ×•×! ğŸ‘‹ ×× ×™ ×”×™×•×¢×¥ ×”×¤×™× × ×¡×™ ×©×œ×š. ×©××œ ××•×ª×™ ×¢×œ × ×™×”×•×œ ×ª×§×¦×™×‘ ××©×¤×—×ª×™ ×‘×™×©×¨××œ.</div>
    </div>
    <form id="chat-form" class="chat-form">
      <input id="chat-input" type="text" placeholder="×©××œ ××•×ª×™ ×¢×œ × ×™×”×•×œ ×ª×§×¦×™×‘..." required />
      <button type="submit">×©×œ×—</button>
    </form>
    <div class="examples">
      <p>×©××œ×•×ª ×œ×“×•×’××”:</p>
      <button type="button" class="example-btn">×§×¨×Ÿ ×—×™×¨×•×</button>
      <button type="button" class="example-btn">×”×•×¦××•×ª ××©×¤×—×”</button>
      <button type="button" class="example-btn">×˜×™×¤×™× ×œ×—×™×¡×›×•×Ÿ</button>
      <button type="button" class="example-btn">×›×œ×œ ×”×ª×§×¦×™×‘</button>
      <button type="button" class="example-btn">×§×¦×‘××•×ª</button>
      <button type="button" class="example-btn">× ×™×”×•×œ ×—×•×‘×•×ª</button>
    </div>
  </div>

  <div class="col docs-col">
    <section class="card">
      <h2>ğŸ“Š ×¡×˜×˜×•×¡ ××¢×¨×›×ª</h2>
      <div id="status" class="status-box">×‘×•×“×§ ×—×™×‘×•×¨...</div>
    </section>

    <section class="card">
      <h2>ğŸ“š ××§×•×¨×•×ª ××™×“×¢</h2>
      <div id="sources" class="sources-box">
        <p class="muted">×”××§×•×¨×•×ª ×™×•×¤×™×¢×• ×›××Ÿ ×œ××—×¨ ×©××œ×”</p>
      </div>
    </section>
  </div>
</section>

<script>
(function() {
  const msgs = document.getElementById("messages");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const status = document.getElementById("status");
  const sources = document.getElementById("sources");

  function addBubble(text, who) {
    const div = document.createElement("div");
    div.className = "bubble " + who;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }

  function showSources(context) {
    if (!context || context.length === 0) {
      sources.innerHTML = '<p class="muted">×œ× × ××¦××• ××§×•×¨×•×ª</p>';
      return;
    }
    let html = '<ul class="sources-list">';
    context.forEach(function(src, i) {
      html += '<li><strong>××§×•×¨ ' + (i + 1) + ':</strong> ' + src + '</li>';
    });
    html += '</ul>';
    sources.innerHTML = html;
  }

  async function askQuestion(question) {
    addBubble(question, "user");
    const bot = addBubble("××—×¤×© ×ª×©×•×‘×”...", "bot");
    sources.innerHTML = '<p class="muted">××—×¤×© ××§×•×¨×•×ª...</p>';
    
    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({question: question, k: 5})
      });
      const data = await res.json();
      
      if (data.error) {
        bot.textContent = "×©×’×™××”: " + data.error;
        sources.innerHTML = '<p class="muted">×©×’×™××” ×‘×˜×¢×™× ×ª ××§×•×¨×•×ª</p>';
      } else {
        bot.textContent = data.answer;
        showSources(data.context);
      }
    } catch(e) {
      bot.textContent = "×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª";
      sources.innerHTML = '<p class="muted">×©×’×™××ª ×—×™×‘×•×¨</p>';
    }
  }

  document.querySelectorAll(".example-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      askQuestion(btn.textContent);
    });
  });

  form.addEventListener("submit", function(e) {
    e.preventDefault();
    const q = input.value.trim();
    if (q) {
      askQuestion(q);
      input.value = "";
    }
  });

  fetch("/health")
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.knowledge_base_configured) {
        status.innerHTML = '<div class="status-ok">âœ… ××—×•×‘×¨</div>' +
          '<div class="status-detail">Region: ' + d.region + '</div>' +
          '<div class="status-detail">KB: ' + (d.knowledge_base_id || 'N/A') + '</div>';
      } else {
        status.innerHTML = '<div class="status-error">âš ï¸ Knowledge Base ×œ× ××•×’×“×¨</div>';
      }
    })
    .catch(function() {
      status.innerHTML = '<div class="status-error">âŒ ×©×’×™××ª ×—×™×‘×•×¨</div>';
    });
})();
</script>
{% endblock %}